<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organ Transplant System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .hidden { display: none; } .card { margin-bottom: 20px; } .status { padding: 10px; border-radius: 5px; margin-bottom: 20px; }
        .connected { background-color: #d4edda; } .disconnected { background-color: #f8d7da; }
        #eventsLog { height: 200px; overflow-y: auto; background-color: #f8f9fa; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 14px; }
        .section-title { border-bottom: 2px solid #0d6efd; padding-bottom: 10px; margin-bottom: 20px; }
        .role-indicator { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; margin-left: 8px; }
        .role-hospital { background-color: #dc3545; color: white; } .role-patient { background-color: #198754; color: white; }
        .role-unregistered { background-color: #6c757d; color: white; } .role-inactive { background-color: #ffc107; color: black; }
        .role-node { background-color: #0dcaf0; color: black; }
        .role-owner { background-color: #6f42c1; color: white; } /* NEW */
        .modal-body { max-height: 60vh; overflow-y: auto; }
        .status-waiting { color: #0d6efd; } .status-matched { color: #fd7e14; } .status-patientapproved { color: #ffc107; } 
        .status-medicallyapproved { color: #6f42c1; }
        .status-completed { color: #198754; }
        .trust-score { font-size: 0.9em; color: #6c757d; } /* NEW */
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container"><a class="navbar-brand" href="#">Organ Transplant System</a><div class="navbar-nav ms-auto"><span id="accountInfo" class="navbar-text">Not connected</span><button id="connectButton" class="btn btn-outline-light ms-2">Connect Wallet</button></div></div>
    </nav>

    <div class="container mt-4">
        <div id="connectionStatus" class="status disconnected"><strong>Status:</strong> Please connect your MetaMask wallet.</div>
        <div id="loadingIndicator" class="d-flex justify-content-center hidden"><div class="spinner-border text-primary"></div><span class="ms-2">Loading...</span></div>
        <div id="defaultInterface" class="hidden"><div class="alert alert-info"><h4>Welcome!</h4><p>Your account is not registered.</p></div></div>

        <div id="ownerInterface" class="hidden">
            <h2 class="section-title">Owner Dashboard</h2>
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header"><h5>Propose New Hospital</h5></div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">New Hospital Address</label>
                                <input type="text" class="form-control" id="newHospitalAddress" placeholder="0x...">
                            </div>
                            <button id="proposeHospitalButton" class="btn btn-primary">Propose Hospital</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header"><h5>Pending Proposals</h5></div>
                        <div class="card-body" id="ownerPendingProposals">
                            <p class="text-muted">No pending proposals.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="hospitalInterface" class="hidden">
            <h2 class="section-title">Hospital Dashboard <span id="hospitalTrustScore" class="fs-5 text-muted"></span></h2>
            <div id="hospitalLogisticsSection" class="hidden"><div class="card border-info"><div class="card-header bg-info text-white"><h5>Logistics Actions</h5></div><div class="card-body" id="hospitalLogisticsContainer"></div></div></div>
            <button id="viewQueuesBtn" class="btn btn-info mb-3">View Patient & Donor Queues</button>
            
            <div id="hospitalProposalSection" class="hidden"><div class="card border-purple"><div class="card-header" style="background-color: #6f42c1; color: white;"><h5>Action Required: Vote on New Hospitals</h5></div><div class="card-body" id="hospitalProposalContainer"></div></div></div>

            <div id="pendingActionsSection" class="hidden"><div class="card border-warning"><div class="card-header bg-warning"><h5>Action Required: Pending Match Votes</h5></div><div class="card-body" id="pendingActionsContainer"></div></div></div>
            <div class="row">
                <div class="col-md-6"><div class="card"><div class="card-header"><h5>Register Donor</h5></div><div class="card-body"><div class="mb-3"><label class="form-label">Blood Type</label><select class="form-select" id="donorBloodType"><option value="0">O-</option><option value="1">O+</option><option value="2">A-</option><option value="3">A+</option><option value="4">B-</option><option value="5">B+</option><option value="6">AB-</option><option value="7">AB+</option></select></div><div class="mb-3"><label class="form-label">Organ</label><input type="text" class="form-control" id="organType" placeholder="e.g., Kidney"></div><button id="registerDonorButton" class="btn btn-primary">Register Donor</button></div></div></div>
            
                <div class="card col-md-12"><div class="card-header"><h5>Register Patient</h5></div><div class="card-body row"><div class="col-md-4"><label class="form-label">Patient Address</label><input type="text" class="form-control" id="patientAddress" placeholder="0x..."></div><div class="col-md-4"><label class="form-label">Blood Type</label><select class="form-select" id="bloodType"><option value="0">O-</option><option value="1">O+</option><option value="2">A-</option><option value="3">A+</option><option value="4">B-</option><option value="5">B+</option><option value="6">AB-</option><option value="7">AB+</option></select></div><div class="col-md-4"><label class="form-label">Organ Needed</label><input type="text" class="form-control" id="organNeeded" placeholder="e.g., Kidney"></div><div class="col-12"><button id="registerPatientButton" class="btn btn-primary mt-3">Register Patient</button></div></div></div>
            </div>
        </div>

        <div id="patientInterface" class="hidden">
            <h2 class="section-title">Patient Dashboard</h2>
             <div id="patientTrackingSection" class="hidden"><div class="card border-primary"><div class="card-header bg-primary text-white"><h5>Your Organ Transplant Journey</h5></div><div class="card-body" id="patientTrackingContainer"></div></div></div>
            <button id="viewQueuesBtnPatient" class="btn btn-info mb-3">View Patient & Donor Queues</button>
            <div id="pendingPreApprovalSection" class="hidden"><div class="card border-info"><div class="card-header bg-info text-white"><h5>Action Required: Pre-Approve Transfer</h5></div><div class="card-body" id="pendingPreApprovalContainer"></div></div></div>
            <div id="pendingAcceptanceSection" class="hidden"><div class="card border-success"><div class="card-header bg-success text-white"><h5>Action Required: Finalize Medical Approval</h5></div><div class="card-body" id="pendingAcceptanceContainer"></div></div></div>
            <div class="card"><div class="card-header"><h5>Your Information</h5></div><div class="card-body"><p><strong>Account:</strong> <span id="patientAddressDisplay"></span></p><p><strong>Status:</strong> <strong id="patientStatus" class="status-waiting"></strong></p></div></div>
        </div>

        <div id="transactionNodeInterface" class="hidden">
            <h2 class="section-title">Transaction Node Dashboard</h2>
            <div id="nodeLogisticsSection"><div class="card border-info"><div class="card-header bg-info text-white"><h5>Active Deliveries</h5></div><div class="card-body" id="nodeLogisticsContainer"><p class="text-muted">No active deliveries assigned.</p></div></div></div>
        </div>

        <div class="card mt-4"><div class="card-header bg-dark text-white"><h5>System Events</h5></div><div class="card-body"><div id="eventsLog"><p class="text-muted">Events will appear here...</p></div></div></div>
    </div>

    <div class="modal fade" id="queueModal" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Patient & Donor Queues</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="row">
        <div id="patientListCol" class="col-md-4"><h6>Patients Queue</h6><div id="patientList"></div></div>
        <div id="donorListCol" class="col-md-4"><h6>Donors Queue</h6><div id="donorList"></div></div>
        <div id="potentialMatchListCol" class="col-md-4"><h6>Potential Matches</h6><div id="potentialMatchList"></div></div>
    </div></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <script>
        // --- State and Initial Setup ---
        let organTransplant, accounts, currentAccount, web3;
        let listenersAttached = false, queueModal;
        const el = id => document.getElementById(id);

        window.addEventListener('load', async () => {
            queueModal = new bootstrap.Modal(el('queueModal'));
            const btnMap = {
                'connectButton': initApp, 'registerPatientButton': registerPatient,
                'registerDonorButton': registerDonor, 'viewQueuesBtn': showQueues, 'viewQueuesBtnPatient': showQueues,
                'proposeHospitalButton': proposeHospital // NEW
            };
            for (const [id, func] of Object.entries(btnMap)) { el(id).addEventListener('click', func); }
            if (window.ethereum) {
                const accs = await window.ethereum.request({ method: 'eth_accounts' });
                if (accs.length > 0) await initApp();
            }
        });

        // --- Core Application Logic ---
        async function initApp() {
            if (!window.ethereum) return alert("Please install MetaMask!");
            try {
                el('loadingIndicator').classList.remove('hidden');
                web3 = new Web3(window.ethereum);
                const artifact = await (await fetch("OrganTransplant.json")).json();
                const networkId = await web3.eth.net.getId();
                if (!artifact.networks[networkId]) throw new Error("Contract not deployed on this network.");
                accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                currentAccount = accounts[0];
                organTransplant = new web3.eth.Contract(artifact.abi, artifact.networks[networkId].address);
                updateConnectionUI();
                await refreshAllData();
                setupEventListeners();
            } catch (e) {
                el('connectionStatus').innerHTML = `<strong>Status:</strong> Error: ${e.message}`;
                console.error(e);
            } finally {
                el('loadingIndicator').classList.add('hidden');
            }
        }
        
        async function refreshAllData() {
            ['defaultInterface', 'hospitalInterface', 'patientInterface', 'transactionNodeInterface', 'ownerInterface'].forEach(id => el(id).classList.add('hidden'));
            let role = "Unregistered", roleClass = "role-unregistered";
            try {
                const owner = await organTransplant.methods.owner().call();
                const transactionNode = await organTransplant.methods.transactionNode().call();

                if (currentAccount.toLowerCase() === owner.toLowerCase()) {
                    el('ownerInterface').classList.remove('hidden');
                    role = "Owner"; roleClass = "role-owner";
                    await refreshOwnerActions(); // NEW
                } else if (currentAccount.toLowerCase() === transactionNode.toLowerCase()) {
                    el('transactionNodeInterface').classList.remove('hidden');
                    role = "Transaction Node"; roleClass = "role-node";
                } else {
                    const hospital = await organTransplant.methods.hospitals(currentAccount).call();
                    if (hospital.exists) {
                        el('hospitalInterface').classList.remove('hidden');
                        role = "Hospital";
                        roleClass = "role-hospital";
                        // NEW: Display trust score
                        const n = hospital.trustNumerator;
                        const d = hospital.trustDenominator;
                        el('hospitalTrustScore').textContent = `(Trust Score: ${n}/${d} = ${d > 0 ? ((n/d)*100).toFixed(1) : 'N/A'}%)`;
                        await refreshHospitalActions();
                    } else {
                        const patient = await organTransplant.methods.patients(currentAccount).call();
                        if (patient.addr !== '0x0000000000000000000000000000000000000000') {
                            el('patientInterface').classList.remove('hidden');
                            role = "Patient"; roleClass = "role-patient";
                            const organNeeded = web3.utils.hexToUtf8(patient.organNeeded);
                            el('patientAddressDisplay').textContent = `${currentAccount.substring(0,10)}... (Needs: ${organNeeded}, Blood: ${getBloodTypeName(patient.bloodType)})`;
                            const statusText = getStatusName(patient.status);
                            el('patientStatus').textContent = statusText;
                            el('patientStatus').className = `status-${statusText.toLowerCase()}`;
                            await refreshPatientActions(patient.status);
                        } else {
                            el('defaultInterface').classList.remove('hidden');
                        }
                    }
                }
                await refreshLogisticsPanels();
            } catch(e) { console.error("Role detection error", e); }
            el('accountInfo').innerHTML = `Connected: ${currentAccount.substring(0,6)}... <span class="role-indicator ${roleClass}">${role}</span>`;
        }

        async function showQueues() {
            const [pList, dList, mList] = [el('patientList'), el('donorList'), el('potentialMatchList')];
            [pList, dList, mList].forEach(l => l.innerHTML = '<div class="spinner-border spinner-border-sm"></div>');
            const isHospital = !el('hospitalInterface').classList.contains('hidden');
            el('potentialMatchListCol').classList.toggle('hidden', !isHospital);
            el('patientListCol').className = isHospital ? 'col-md-4' : 'col-md-6';
            el('donorListCol').className = isHospital ? 'col-md-4' : 'col-md-6';
            queueModal.show();
            
            try {
                // --- THIS IS THE FIX ---
                // 1. Get the total count of hospitals
                const hospitalCount = parseInt(await organTransplant.methods.getHospitalCount().call());
                
                // 2. Create an array of promises to fetch each address by index
                const hospitalAddrPromises = [];
                for (let i = 0; i < hospitalCount; i++) {
                    hospitalAddrPromises.push(organTransplant.methods.hospitalAddresses(i).call());
                }
                const hospitalAddrs = await Promise.all(hospitalAddrPromises);
                // --- END OF FIX ---

                // Fetch all hospitals to get their trust scores
                const hospitalData = await Promise.all(hospitalAddrs.map(addr => organTransplant.methods.hospitals(addr).call().then(h => ({...h, addr}))));
                const hospitalScoreMap = new Map(hospitalData.map(h => [h.addr.toLowerCase(), `${h.trustNumerator}/${h.trustDenominator}`]));
                
                const dCount = await organTransplant.methods.getDonorCount().call();
                const allDonorsPromise = Promise.all(
                    Array.from({length: dCount}, (_, i) => organTransplant.methods.donors(i + 1).call())
                );
                
                const patientEvents = await organTransplant.getPastEvents('PatientRegistered', { fromBlock: 0, toBlock: 'latest' });
                const uniquePatientAddresses = [...new Set(patientEvents.map(e => e.returnValues.patient))];
                
                const allPatientsPromise = Promise.all(
                    uniquePatientAddresses.map(addr => organTransplant.methods.patients(addr).call().then(p => ({...p, addr})))
                );

                const [allDonors, allPatients] = await Promise.all([allDonorsPromise, allPatientsPromise]);

                pList.innerHTML = allPatients.map(p => {
                    const score = hospitalScoreMap.get(p.registeredBy.toLowerCase()) || 'N/A';
                    return `<div class="card card-body mb-2 small">Addr: ${p.addr.substring(0,10)}...<br/>Needs: ${web3.utils.hexToUtf8(p.organNeeded)} | <strong class="status-${getStatusName(p.status).toLowerCase()}">${getStatusName(p.status)}</strong><br/><small class="text-muted">By: ${p.registeredBy.substring(0,10)}... <span class="trust-score">(Score: ${score})</span></small></div>`;
                }).join('') || 'No patients.';
                
                dList.innerHTML = allDonors.map(d => {
                    const score = hospitalScoreMap.get(d.registeredBy.toLowerCase()) || 'N/A';
                    return `<div class="card card-body mb-2 small">ID: ${d.id} | Has: ${web3.utils.hexToUtf8(d.organ)}<br/>Status: <strong class="status-${getStatusName(d.status).toLowerCase()}">${getStatusName(d.status)}</strong><br/><small class="text-muted">By: ${d.registeredBy.substring(0,10)}... <span class="trust-score">(Score: ${score})</span></small></div>`;
                }).join('') || 'No donors.';
                
                if (isHospital) {
                    mList.innerHTML = allDonors
                        .filter(d => d.status == "0")
                        .flatMap(d => allPatients
                            .filter(p => p.status == "0" && 
                                web3.utils.hexToUtf8(d.organ).toLowerCase() === web3.utils.hexToUtf8(p.organNeeded).toLowerCase() && 
                                isBloodTypeCompatibleJS(d.bloodType, p.bloodType)
                            )
                            .map(p => `<div class="card card-body mb-2 small"><p><b>Donor ${d.id} â†” Patient ${p.addr.substring(0,8)}...</b></p><button class="btn btn-sm btn-primary" onclick="createMatch(${d.id}, '${p.addr}')">Create Match</button></div>`)
                        ).join('') || 'No compatible pairs found.';
                }
            } catch (e) { 
                console.error("Error building queue:", e);
                [pList, dList, mList].forEach(l => l.innerHTML = 'Error loading data.'); 
            }
        }
        
        async function refreshHospitalActions() {
            // 1. Refresh Match Voting
            const matchContainer = el('pendingActionsContainer'); matchContainer.innerHTML = '';
            const matchCounter = await organTransplant.methods.matchCounter().call();
            let foundMatch = false;
            for (let i = 1; i <= matchCounter; i++) {
                const match = await organTransplant.methods.matches(i).call();
                if(match.completed) continue;
                const patient = await organTransplant.methods.patients(match.patient).call();
                if (patient.status == "2") { // PatientApproved
                    const hasVoted = await organTransplant.methods.hasHospitalVoted(i, currentAccount).call();
                    if (!hasVoted) {
                        foundMatch = true;
                        matchContainer.innerHTML += `<div class="alert alert-light"><p class="mb-1"><strong>Match ID: ${i}</strong> is pre-approved by patient. Awaiting your vote.</p><button class="btn btn-sm btn-warning me-2" onclick="initiateAndVote(${i}, true)">Approve</button><button class="btn btn-sm btn-danger" onclick="initiateAndVote(${i}, false)">Reject</button></div>`;
                    }
                }
            }
            el('pendingActionsSection').classList.toggle('hidden', !foundMatch);

            // 2. Refresh Hospital Proposal Voting (NEW)
            // 2. Refresh Hospital Proposal Voting (NEW)
            const proposalContainer = el('hospitalProposalContainer'); proposalContainer.innerHTML = '';
            const pendingProposals = await organTransplant.methods.getPendingProposals().call();
            let foundProposal = false;
            if (pendingProposals.length > 0) {
                for (const proposalAddr of pendingProposals) {
                    
                    // --- THIS IS THE FIX ---
                    // Call our new getter function to check if WE have voted
                    const hasVoted = await organTransplant.methods.getProposalVoteStatus(proposalAddr, currentAccount).call();
                    // --- END OF FIX ---

                    if (!hasVoted) {
                        foundProposal = true;
                        // Now we can fetch the rest of the proposal info
                        const proposal = await organTransplant.methods.hospitalProposals(proposalAddr).call();
                        const totalHospitals = parseInt(await organTransplant.methods.getHospitalCount().call());
                        const requiredVotes = totalHospitals > 0 ? Math.ceil(totalHospitals * 2 / 3) : 1;
                        
                        proposalContainer.innerHTML += `<div class="alert alert-light">
                            <p class="mb-1"><strong>New Hospital Proposal:</strong> <code>${proposalAddr}</code></p>
                            <p class="text-muted small">Current Votes: ${proposal.yesVotes} / ${requiredVotes} required</p>
                            <button class="btn btn-sm btn-success me-2" onclick="voteOnHospital('${proposalAddr}', true)">Approve</button>
                            <button class="btn btn-sm btn-danger" onclick="voteOnHospital('${proposalAddr}', false)">Reject</button>
                        </div>`;
                    }
                }
            }
            el('hospitalProposalSection').classList.toggle('hidden', !foundProposal);
        }

        // NEW: Refresh Owner Actions
        async function refreshOwnerActions() {
            const proposalContainer = el('ownerPendingProposals');
            proposalContainer.innerHTML = '';
            const pendingProposals = await organTransplant.methods.getPendingProposals().call();
            if (pendingProposals.length > 0) {
                let html = '';
                for (const proposalAddr of pendingProposals) {
                    const proposal = await organTransplant.methods.hospitalProposals(proposalAddr).call();
                    const totalHospitals = parseInt(await organTransplant.methods.getHospitalCount().call());
                    const requiredVotes = totalHospitals > 0 ? Math.ceil(totalHospitals * 2 / 3) : 1;
                    html += `<div class="alert alert-light">
                        <p class="mb-1"><code>${proposalAddr}</code></p>
                        <p class="text-muted small mb-0">Votes: ${proposal.yesVotes} / ${requiredVotes}</p>
                    </div>`;
                }
                proposalContainer.innerHTML = html;
            } else {
                proposalContainer.innerHTML = '<p class="text-muted">No pending proposals.</p>';
            }
        }

        async function refreshPatientActions(patientStatus) {
            el('pendingPreApprovalSection').classList.add('hidden');
            el('pendingAcceptanceSection').classList.add('hidden');
            const matchCounter = await organTransplant.methods.matchCounter().call();
            for (let i = 1; i <= matchCounter; i++) {
                const match = await organTransplant.methods.matches(i).call();
                if (match.patient.toLowerCase() !== currentAccount.toLowerCase() || match.completed) continue;
                
                if (patientStatus == "1") { // Matched
                    el('pendingPreApprovalContainer').innerHTML = `<p><strong>Match ID: ${i}</strong> is ready for your pre-approval.</p><button class="btn btn-sm btn-info" onclick="patientPreApprove(${i})">Pre-Approve Transfer</button>`;
                    el('pendingPreApprovalSection').classList.remove('hidden');
                } else if (patientStatus == "2") { // PatientApproved
                    const totalActiveHospitals = parseInt(await organTransplant.methods.getHospitalCount().call());
                    const requiredVotes = totalActiveHospitals > 0 ? Math.ceil(totalActiveHospitals * 2 / 3) : 1;
                    const currentVotes = parseInt(match.yesVotes);
                    
                    let acceptanceHtml = `<p><strong>Match ID: ${i}</strong> is awaiting hospital approval. (${currentVotes} of ${requiredVotes} required votes received).</p>`;
                    if (currentVotes >= requiredVotes) {
                        acceptanceHtml = `<p><strong>Match ID: ${i}</strong> has been approved by the hospitals!</p><button class="btn btn-sm btn-success" onclick="patientAccept(${i})">Finalize Medical Approval</button>`;
                    }
                    el('pendingAcceptanceContainer').innerHTML = acceptanceHtml;
                    el('pendingAcceptanceSection').classList.remove('hidden');
                }
            }
        }

        async function refreshLogisticsPanels() {
            // This function logic remains the same
            let hospitalHtml = '', patientHtml = '', nodeHtml = '';
            const matchCounter = parseInt(await organTransplant.methods.matchCounter().call());
            if (matchCounter === 0) return;
            const matchPromises = Array.from({length: matchCounter}, (_, i) => organTransplant.methods.matches(i + 1).call());
            const logisticsPromises = Array.from({length: matchCounter}, (_, i) => organTransplant.methods.logistics(i + 1).call());
            const allMatches = await Promise.all(matchPromises);
            const allLogistics = await Promise.all(logisticsPromises);
            for(let i = 0; i < matchCounter; i++) {
                const match = allMatches[i];
                const logistics = allLogistics[i];
                const matchId = i + 1;
                if (logistics.status === "0") continue; 
                const logisticsStatusText = getLogisticsStatusName(logistics.status);
                const isPatientForThisMatch = match.patient.toLowerCase() === currentAccount.toLowerCase();
                const isDonorHospital = logistics.donorHospital.toLowerCase() === currentAccount.toLowerCase();
                const isRecipientHospital = logistics.recipientHospital.toLowerCase() === currentAccount.toLowerCase();
                const isTransactionNode = !el('transactionNodeInterface').classList.contains('hidden');
                if (isPatientForThisMatch) {
                    patientHtml = `<p><strong>Organ Transaction ID: ${matchId}</strong><br>Status: <strong>${logisticsStatusText}</strong></p>`;
                    if(logistics.status === "6") patientHtml += `<p class="text-success fw-bold">SUCCESS: Your transplant journey is complete!</p>`;
                    if(logistics.status === "7") patientHtml += `<p class="text-danger fw-bold">ALERT: The delivery was rejected by the recipient hospital. Please contact them for more information.</p>`;
                }
                if (isDonorHospital) {
                    if (logistics.status === "1") {
                        hospitalHtml += `<div class="alert alert-light"><p><strong>Tx ID ${matchId}:</strong> Confirm the organ is prepared and ready for pickup.</p><button class="btn btn-sm btn-primary" onclick="donorHospitalConfirmReady(${matchId})">Confirm Organ is Ready</button></div>`;
                    } else if (logistics.status === "3") {
                        hospitalHtml += `<div class="alert alert-warning"><p><strong>Tx ID ${matchId}:</strong> The Transaction Node has reported pickup. Please confirm they have collected the organ to begin transit.</p><button class="btn btn-sm btn-warning" onclick="donorHospitalConfirmNodePickup(${matchId})">Confirm Node Pickup</button></div>`;
                    } else if (logistics.status === "7") {
                        hospitalHtml += `<div class="alert alert-danger"><p class="fw-bold">ALERT for Tx ID ${matchId}:</strong> The delivery was REJECTED by the recipient hospital.</p></div>`;
                    }
                }
                if(isRecipientHospital) {
                    if (logistics.status === "5") {
                        hospitalHtml += `<div class="alert alert-light"><p><strong>Tx ID ${matchId}:</strong> The organ has been delivered. Please inspect and confirm receipt or reject the delivery.</p>
                                        <button class="btn btn-sm btn-success me-2" onclick="recipientHospitalConfirmReceipt(${matchId})">Confirm Organ Receipt</button>
                                        <button class="btn btn-sm btn-danger" onclick="recipientHospitalRejectDelivery(${matchId})">Reject Delivery</button></div>`;
                    }
                }
                if (isTransactionNode) {
                    if (logistics.status === "2") {
                        nodeHtml += `<div class="alert alert-light"><p><strong>Tx ID ${matchId}:</strong> Organ is ready for pickup from ${logistics.donorHospital.substring(0,10)}...</p><button class="btn btn-sm btn-primary" onclick="transactionNodeConfirmPickup(${matchId})">Confirm Organ Pickup</button></div>`;
                    } else if (logistics.status === "3") {
                        nodeHtml += `<div class="alert alert-secondary"><p><strong>Tx ID ${matchId}:</strong> Waiting for Donor Hospital to confirm your pickup...</p></div>`;
                    } else if (logistics.status === "4") {
                        nodeHtml += `<div class="alert alert-light"><p><strong>Tx ID ${matchId}:</strong> You are in transit to ${logistics.recipientHospital.substring(0,10)}...</p><button class="btn btn-sm btn-info" onclick="transactionNodeConfirmDelivery(${matchId})">Confirm Organ Delivery</button></div>`;
                    } else if (logistics.status === "6") {
                        nodeHtml += `<div class="alert alert-success"><p><strong>Tx ID ${matchId}:</strong> Delivery successfully confirmed by recipient hospital. Job complete.</p></div>`;
                    }
                }
            }
            el('patientTrackingSection').classList.toggle('hidden', !patientHtml);
            el('patientTrackingContainer').innerHTML = patientHtml;
            el('hospitalLogisticsSection').classList.toggle('hidden', !hospitalHtml);
            el('hospitalLogisticsContainer').innerHTML = hospitalHtml;
            if(nodeHtml) { el('nodeLogisticsContainer').innerHTML = nodeHtml; }
            else if (isTransactionNode) { el('nodeLogisticsContainer').innerHTML = '<p class="text-muted">No active deliveries assigned.</p>'; }
        }

        // --- Contract Call Helpers ---
        const contractCall = async (method, options = {}, ...args) => { 
            console.log("Calling", method, "with args", args);
            try { 
                const tx = await organTransplant.methods[method](...args).send({ from: currentAccount, ...options }); 
                console.log("Transaction successful:", tx);
            } catch (e) { 
                console.error("Transaction Failed:", e);
                alert(`Transaction Failed: ${e.message}`); 
            } 
        };
        
        const registerPatient = () => {
            const organNeeded = el('organNeeded').value;
            if (!organNeeded) return alert("Please enter an organ.");
            if (organNeeded.length > 32) return alert("Organ name max 32 chars.");
            const organHex = web3.utils.utf8ToHex(organNeeded);
            contractCall('registerPatient', {}, el('patientAddress').value, el('bloodType').value, organHex);
        };
        
        const registerDonor = () => {
            const organType = el('organType').value;
            if (!organType) return alert("Please enter an organ.");
            if (organType.length > 32) return alert("Organ name max 32 chars.");
            const organHex = web3.utils.utf8ToHex(organType);
            contractCall('registerDonor', {}, el('donorBloodType').value, organHex);
        };
        
        // NEW functions
        const proposeHospital = () => {
            const addr = el('newHospitalAddress').value;
            if (!web3.utils.isAddress(addr)) return alert("Invalid Ethereum address.");
            contractCall('proposeHospital', {}, addr);
        };
        const voteOnHospital = (addr, approve) => contractCall('voteOnHospital', {}, addr, approve);

        const createMatch = (donorId, patientAddr) => { contractCall('createMatch', {}, donorId, patientAddr); queueModal.hide(); };
        const patientPreApprove = (matchId) => contractCall('patientPreApprove', {}, matchId);
        const initiateAndVote = (matchId, approve) => contractCall('initiateAndVote', {}, matchId, approve);
        const patientAccept = (matchId) => contractCall('patientAccept', {}, matchId);
        const donorHospitalConfirmReady = (matchId) => contractCall('donorHospitalConfirmReady', {}, matchId);
        const transactionNodeConfirmPickup = (matchId) => contractCall('transactionNodeConfirmPickup', {}, matchId);
        const donorHospitalConfirmNodePickup = (matchId) => contractCall('donorHospitalConfirmNodePickup', {}, matchId);
        const transactionNodeConfirmDelivery = (matchId) => contractCall('transactionNodeConfirmDelivery', {}, matchId);
        const recipientHospitalConfirmReceipt = (matchId) => contractCall('recipientHospitalConfirmReceipt', {}, matchId);
        const recipientHospitalRejectDelivery = (matchId) => contractCall('recipientHospitalRejectDelivery', {}, matchId);
        
        // --- Event Listeners and UI Helpers ---
        function setupEventListeners() {
            if (listenersAttached) return;
            listenersAttached = true;
            organTransplant.events.allEvents()
                .on('data', e => { 
                    logEvent(`Event: ${e.event}`); 
                    console.log("Event data:", e);
                    // Use a longer timeout to ensure state is updated on-chain
                    setTimeout(() => refreshAllData(), 2000); 
                })
                .on('error', console.error);
                
            window.ethereum.on('accountsChanged', accs => { 
                if(accs.length > 0) { 
                    currentAccount = accs[0]; 
                    logEvent("Account changed."); 
                    refreshAllData(); 
                    updateConnectionUI(); 
                }
            });
            window.ethereum.on('chainChanged', () => window.location.reload());
        }
        
        function updateConnectionUI() {
            el('connectionStatus').innerHTML = '<strong>Status:</strong> Connected.';
            el('connectionStatus').className = 'status connected';
            el('connectButton').textContent = 'Connected';
            el('connectButton').disabled = true;
        }
        
        function logEvent(message) {
            const log = el('eventsLog');
            if (log.innerHTML.includes('will appear here...')) log.innerHTML = '';
            log.innerHTML += `<p class="mb-1"><strong>[${new Date().toLocaleTimeString()}]</strong> ${message}</p>`;
            log.scrollTop = log.scrollHeight;
        }
        
        function getBloodTypeName(code) { return ['O-', 'O+', 'A-', 'A+', 'B-', 'B+', 'AB-', 'AB+'][code] || 'Unknown'; }
        function getStatusName(code) { return ['Waiting', 'Matched', 'PatientApproved', 'MedicallyApproved', 'Completed'][code] || 'Unknown'; }
        function getLogisticsStatusName(code) { 
            return [
                'Inactive', 'Awaiting Donor Hospital Readiness', 'Ready For Pickup', 
                'Awaiting Donor Hospital Confirmation of Pickup', 'In Transit', 'Delivered to Recipient Hospital', 
                'Confirmed By Recipient', 'Delivery Rejected'
            ][code] || 'Unknown'; 
        }
        
        function isBloodTypeCompatibleJS(donorType, patientType) {
            const d = parseInt(donorType);
            const p = parseInt(patientType);
            if (d === 0) return true;
            if (d === 1 && [1, 3, 5, 7].includes(p)) return true;
            if (d === 2 && [2, 3, 6, 7].includes(p)) return true;
            if (d === 3 && [3, 7].includes(p)) return true;
            if (d === 4 && [4, 5, 6, 7].includes(p)) return true;
            if (d === 5 && [5, 7].includes(p)) return true;
            if (d === 6 && [6, 7].includes(p)) return true;
            if (d === 7 && p === 7) return true;
            return false;
        }
    </script>
</body>
</html>